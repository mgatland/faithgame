<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
<link rel="icon" 
      type="image/png" 
      href="favicon.png">
<link href="faith.css" rel="stylesheet">
<script src="FileSaver.js"></script>
<script type="text/javascript" > 
  var contexts = new Array();
  var version="0.1";
  var gameLink=""
  var canvasIndex=0;
  var canvasses = new Array();
  var hyperlinks = new Array();
  var numFrames = 10;
  var numColors = 4;
  var thumbSize = 20;
  var begun = false;
  var finished = false;
  var frameData = new Array();

  var shareLinkInner=null;

  //http://stackoverflow.com/questions/1484506/random-color-generator-in-javascript
  function getRandomColor() {
      var letters = '0123456789ABCDEF'.split('');
      var color = '#';
      for (var i = 0; i < 6; i++ ) {
          color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
  }


  function getCookie(name) {
    var value = "; " + document.cookie;
    var parts = value.split("; " + name + "=");
    if (parts.length == 2) return parts.pop().split(";").shift();
  }

  var colorPalette = null;
  var oldColors = getCookie("colorPalette");
  if (oldColors) {
    colorPalette = JSON.parse(oldColors);
    if (!colorPalette || !colorPalette.length || colorPalette.length != numColors) {
      colorPalette = null;
    }
  }
  if (colorPalette == null) {
    colorPalette = [
              getRandomColor(),
              getRandomColor(),
              getRandomColor(),
              getRandomColor()
              ];
    document.cookie = "colorPalette=" + JSON.stringify(colorPalette);
  }

  var messages = [
"frame 1 shall be drawn with a single stroke using the colour first chosen for you",
"frame 2 shall be completed using an even number of brushstrokes",
"frame 3 shall use exactly three of the four colours",
"frame 4 shall link to four other frames",
"frame 5 shall be drawn with the left hand",
"frame 6 shall attempt to recreate frame 3",
"frame 7 shall be left blank",
"frame 8 shall be drawn while contemplating the beauty of the natural world",
"frame 9 shall be drawn, but no other frames may link to it",
"frame 10 shall depict a circular motif and link to no other frames"
  ];

  var colorElem = new Array();
    var layerElem = new Array();
  var initialColor=colorIndex=getRandomInt(1,4);

var aurl = document.createElement('a');
function qualifyURL(url) {
  aurl.href = url;
  return aurl.href;
}

var begin = function () {
  begun = true;
  document.getElementById("instructions").style.display = "none";
}

var radiusElem = new Array();
var thumbnailCanvas = new Array();
var thumbnailContext = new Array();
var linkThumbnailCanvas = new Array();
var linkThumbnailContext = new Array();
var linkDisplayElems = new Array();
var linkDisplayContainer;
var linksPopOverElem;
var linksPopOverColor;
var linkPageSelectorNumberElems = new Array();

var standalone_HTML_String="";

var clientStandaloneRequest = new XMLHttpRequest();

clientStandaloneRequest.open('GET', 'play.html');
clientStandaloneRequest.onreadystatechange = function() {

    if(clientStandaloneRequest.readyState!=4) {
      return;
    }
    standalone_HTML_String=clientStandaloneRequest.responseText;
}
clientStandaloneRequest.send();


var get_blob = function() {
    return self.Blob;
}

var timers = [];
for (var i = 0; i < numFrames; i++)
{
  timers[i] = 60.0 * 2.0;
}

var getTwoDigitNum = function (num) {
  if (num >= 10) return num;
  return "0" + num;
}

var getDigitalTime = function (num) {
  num=Math.round(num);
  if (num <= 0)
  {
    return "0:00";
  }
  if (num < 60)
  {
    return "0:" + getTwoDigitNum(num);
  } else {
    return Math.floor(num/60) + ":" + getTwoDigitNum(num % 60);
  }
}

function lerp(colorA, colorB, t) {
  var result=colorB*t + colorA*(1.0-t);
  return result;
}

function toHexColor(r,g,b) {
  return "#"+Math.round(r).toString(16)+Math.round(g).toString(16)+Math.round(b).toString(16);
}

var ticksPerSecond=10;
var timerInterval=1000/ticksPerSecond;
var secondsPerMilisecond=1.0/1000.0;

var updateTimeDisplay = function() {
  for (var timerIndex=0; timerIndex<numFrames; ++timerIndex) {
    document.getElementById("thumbTimer"+(timerIndex+1)).innerHTML = getDigitalTime(timers[timerIndex]);
  }
  var lerpStage=10;
  var timeRemainingThisCanvas=timers[canvasIndex];
  var timerIntervalSeconds=timerInterval*secondsPerMilisecond;
  var flashColorValue=64;
  if (timeRemainingThisCanvas<timerIntervalSeconds) {
    document.body.style.backgroundColor=toHexColor(flashColorValue,flashColorValue,flashColorValue);
  } else if (timeRemainingThisCanvas < lerpStage+0.5) {
    var timeRemainingFraction=timeRemainingThisCanvas/lerpStage;
    // var colorValue=lerp(255, 0, timeRemainingFraction);
    // var newBG="#"+Math.round(colorValue).toString(16)+"0000";
    var subSeconds=(timeRemainingThisCanvas+0.5-Math.floor(timeRemainingThisCanvas+0.5));
    var colorValue=(Math.sin(subSeconds*Math.PI)+1)*flashColorValue*0.5;
    var newBG=toHexColor(colorValue,colorValue,colorValue);
    document.body.style.backgroundColor=newBG;
  } else {
    document.body.style.backgroundColor="";
  }
}

var advanceTimer = function() {
  if (begun && !finished) {
    if (timers[canvasIndex] > 0) {
      timers[canvasIndex]-=timerInterval*secondsPerMilisecond;
    } else {
      timers[canvasIndex]=0;
    }
  }
  updateTimeDisplay();
}
setInterval(function () {
  advanceTimer();
}, timerInterval);

function buildStandalone(sourceCode) {
  if (standalone_HTML_String.length===0) {
    alert("Can't export yet - still downloading html template.",true);
    return;
  }
  sourceCode=encodeURI(sourceCode);
  var htmlString = standalone_HTML_String.concat("");


  htmlString = "<!--Save as html file-->\n"+htmlString;
  htmlString = htmlString.replace(/__EMBED__/g,sourceCode);
  htmlString = htmlString.replace(/"__COLORPALETTE__"/g, "[\"" + colorPalette.join("\",\"") + "\"]");

  var BB = get_blob();
  var blob = new BB([htmlString], {type: "text/plain;charset=utf-8"});
  saveAs(blob, "faithgame.html");
}

function exportClick(){
  var embedDat = stateToString();
  buildStandalone(embedDat);
}

function shareClick() {
  if (window.location.hostname.indexOf("heroku") == -1) {
    exportClick();
  }
  var str = stateToString();
  var request = new XMLHttpRequest();
  request.onreadystatechange = function() { 
    if (request.readyState !== XMLHttpRequest.DONE) {
        return;
    }
    if (request.status !== 200) {
        return;
    }
    window.location = request.responseText;
  }
  request.open('POST', '/newgame', true);
  request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
  request.send("file=" + str);

  //allow new colors
  document.cookie = "colorPalette=null";

  //prevent multiple submissions
  var button = document.getElementById("shareButton");
  button.onclick = "";
  button.className += " disabled";
  finished = true;
  document.getElementById("brushes").className += " hidden";

  var elems = document.querySelectorAll('select');
  for (var i = 0; i < elems.length; i++) {
      elems[i].setAttribute('disabled', "true");
  }
}

function RLE_encode(input) {
    var encoding = [];
    var prev, count, i;
    for (count = 1, prev = input[0], i = 1; i < input.length; i++) {
        if (input[i] != prev) {
            encoding.push(count);
            encoding.push(prev);
            count = 1;
            prev = input[i];
        }
        else 
            count ++;
    }
    encoding.push(count);
    encoding.push(prev);
    return encoding;
}

function RLE_decode(encoded) {
    var output = "";
    encoded.forEach(function(pair){ output += new Array(1+pair[0]).join(pair[1]) })
    return output;
}

function stateToString(){
  var state = new Object();
  state.gameLink=gameLink;
  state.canvasses=new Array();
  for (var i=0;i<numFrames;i++){
    var canvas=canvasses[i];
    var s="";
    for (var j=0;j<width*height;j++){
      s+=canvas[j].toString(16);
    }
    var pairs=RLE_encode(s);    
    state.canvasses.push(pairs);
  }
  state.hyperlinks=hyperlinks;
  state.colorPalette = colorPalette;
  state.initialColor=initialColor;
  state.frameData=frameData;
  var result=JSON.stringify(state);
  return result;
}

function stringToState(str){
  var state = JSON.parse(str);
  gameLink=state.gameLink;
  canvasIndex=0;
  canvasses=new Array();
  for (var k=0;k<state.canvasses.length;k++){
    var s = state.canvasses[k];
    var ar = new Uint8Array(width*height);
    var index=0;
    for (var i=0;i<s.length;i+=2){
      var count=s[i];
      var ch=s[i+1];
      for (var j=0;j<count;j++){
        ar[index]=parseInt(ch,16);
        index++;
      }
    }
    canvasses.push(ar);
  }
  colorPalette = state.colorPalette;
  hyperlinks=state.hyperlinks;
}

document.addEventListener("keydown", press);

var copyImage = null;

var savedString;
function press(evt){
  evt = evt || window.event;
  /*
  if (evt.keyCode==83){//S(ave)
    savedString = stateToString();
  } else if (evt.keyCode==76){//L(oad)
    stringToState(savedString);
    setVisuals();
    setLayer(canvasIndex+1); 
  } */
  if (evt.keyCode===67) { //c
    alert("Hard work is its own reward");
    //copyImage=JSON.stringify(canvasses[canvasIndex])
  } else if (evt.keyCode===86){ //v
    alert("Hard work is its own reward");
    /*
    if (copyImage!==null){
      preserveUndoState();
      var ar = JSON.parse(copyImage);
      var arui8 = new Uint8Array(width*height);
      for (var i=0;i<width*height;i++){
        arui8[i]=ar[i];
      }
      canvasses[canvasIndex]=arui8;
      setVisuals();
    }
    */
  } else if (evt.keyCode ===189 || evt.keyCode===173 ) {//-
    if (radius===3) {
      setRadius(1);
    } else if (radius===5) {
      setRadius(3);
    }else if (radius===7) {
      setRadius(5);
    }else if (radius===9) {
      setRadius(7);
    }else if (radius===11) {
      setRadius(9);
    }else if (radius===13) {
      setRadius(11);
    }else if (radius===16) { 
      setRadius(13);
    }
  } else if (evt.keyCode===187 || evt.keyCode===61){//+
    if (radius===0){
      setRadius(1);
    } else if (radius===1){
      setRadius(3);
    } else if (radius===3) {
      setRadius(5);
    } else if (radius===5) {
      setRadius(7);
    }else if (radius===7) {
      setRadius(9);
    }else if (radius===9) {
      setRadius(11);
    }else if (radius===11) {
      setRadius(13);
    }else if (radius===13) {
      setRadius(16);
    }
  } else if (evt.keyCode===90){//z
    alert("You must accept your mistakes");
    /*
    if (undoList.length>0){
      var dat = undoList.pop();
      canvasses[dat.canvasIndex]=dat.canvasDat;
      setLayer(dat.canvasIndex+1);
      
      if (shareLinkInner!==null){
        shareLinkInner.style.color="gray";
      }
    }
    */
  }
}
  function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min)) + min;
  }
  var width=100;
  var height=100;
  var zoomFactor=6;
  var radius=5;
  var linkMode=false;

  var visibleCanvas;
  var visibleContext;
  var id;
  var id_d;

  var lastX=-1;
  var lastY=-1;

  var bucketElem;
  var linkToolElem;

  function linkChange(newLink){
    gameLink=newLink;
  }

  function clearPalette(){
    preserveUndoState();
    var canvas=canvasses[canvasIndex];
    for (var i=0;i<width*height;i++){
      canvas[i]=0;
    }

    setVisuals();
  }

  function deselectDrawingTools() {
    //reset border around other tools
    bucketElem.classList.remove("selected");
    linkToolElem.classList.remove("selected");
    for(var i=0;i<16;i++){
      if (radiusElem[i]!==null){
        radiusElem[i].classList.remove("selected");
      }
    }
  }

  function setRadius(newRadius) {
      linkMode = false;
      hideLinkPopover();
      radius=newRadius;
      deselectDrawingTools();
      if (newRadius>0){
        radiusElem[newRadius-1].classList.add("selected");
      } else {
        bucketElem.classList.add("selected");
      }
  }

  function setLinkTool() {
    deselectDrawingTools();
    linkToolElem.classList.add("selected");
    linkMode = true;
    hideLinkPopover();
  }

  function createLink(color, destination) {
    if (destination == canvasIndex + 1) {
      destination = 0; //prevent self-links
    }
    hyperlinks[canvasIndex][color]=destination;
    updateLinkDisplays();
    updateAllowedToPublish();
  }

    function setColor(newColorIndex) {
      colorIndex=newColorIndex;
        for(var i=0;i<4;i++){
          if (colorElem[i]!==null){
            colorElem[i].setAttribute("class","unselected");
          }
        }
        colorElem[colorIndex].setAttribute("class","selected");
    }

    function numberOfPagesOpened() {
      var count = 0;
      for (var i = 0; i < numFrames; i++) {
        if (frameData[i].hasBeenOpened == true) count++;
      }
      return count;
    }

    function linksOut(pageIndex) {
      var result=false;
      for (var linkIndex=0; linkIndex<numColors; ++linkIndex) {
        var linksTo=hyperlinks[pageIndex][linkIndex];
        if (linksTo!=0) {
          result=true;
          break;
        }
      }
      return result;
    }

    function updateAllowedToPublish() {
      if (numberOfPagesOpened() >= 9) {
        var numPagesWithLinks=0;
        for (var frameIndex=0; frameIndex<numFrames;++frameIndex) {
          if (linksOut(frameIndex)) {
            ++numPagesWithLinks;
          } else {
          }
        }
        document.getElementById("shareButton").style.display = "";
        if (numPagesWithLinks>2) {
          document.getElementById("linkTip").style.display = "none";
        } else {
          document.getElementById("linkTip").style.display = "";
        }
      }
    }

    function setLayer(newCanvasIndex) {
      document.getElementById("message").innerHTML = messages[newCanvasIndex - 1];
      frameData[newCanvasIndex - 1].hasBeenOpened = true;
      canvasIndex=newCanvasIndex-1;
      layerElem.forEach(el => el.classList.remove("selectedItem"));
      layerElem[canvasIndex].classList.add("selectedItem");
      setVisuals();
      updateLinkDisplays();
      updateTimeDisplay();

      updateAllowedToPublish();

      if (timers[canvasIndex] > 0) {
        visibleCanvas.style.cursor="crosshair";
      }
      updateLinkPopover();
      hideLinkPopover();
    }

    function updateLinkDisplays() {
      for(var i=0;i<numColors;i++){
        var linkTo = hyperlinks[canvasIndex][i];
        var textEl = linkDisplayElems[i].querySelector(".linkPageSelectorNumber");
        textEl.innerHTML = linkTo || "--";
        var ctx = linkDisplayElems[i].querySelector("canvas").getContext("2d");
        if (linkTo > 0) {
          ctx.drawImage(thumbnailCanvas[linkTo-1], 0, 0);
        } else {
          ctx.clearRect(0, 0, thumbnailCanvas[0].width, thumbnailCanvas[0].height);
        }
      }
    }

    function updateLinkPopover() {
      var i = 1;
      for (el of linkPageSelectorNumberElems) {
        el.innerHTML = (i==canvasIndex+1) ? "--" : i;
        i++;
      }
    }

    function showLinkPopover (coords, color, forceUpwards) {
      linksPopOverColor = color;
      linksPopOverElem.querySelector(".colorDisplay").style.backgroundColor=colorPalette[color];
      linksPopOverElem.classList.remove("hidden");
      var popoverHeight = linksPopOverElem.clientHeight;
      if (forceUpwards || coords.y + popoverHeight + 25 >= document.body.scrollHeight) {
        coords.y -= (popoverHeight + 20);
      } else {
        coords.y += 20;
      }
      coords.x -= linksPopOverElem.clientWidth / 2;
      if (coords.x < 5) coords.x = 5;
      if(coords.x + linksPopOverElem.clientWidth > document.body.scrollWidth - 5) {
        coords.x = document.body.scrollWidth - 5 - linksPopOverElem.clientWidth;
      } 
      linksPopOverElem.style.top = (coords.y) + "px";
      linksPopOverElem.style.left = (coords.x) + "px";
    }

    function hideLinkPopover() {
     linksPopOverElem.classList.add("hidden"); 
    }

    function init() {

      radii = new Array();
      for (var i=0;i<16;i++){
        elem = document.getElementById("radius_"+(i+1));
        radiusElem[i]=elem;
        
      }

      linksPopOverElem = document.querySelector(".linksPopOver");

      for (var i=0;i<numFrames;i++){
        elem = document.getElementById("thumbnail"+(i+1));
        elem.width=thumbSize;
        elem.height=thumbSize;
        thumbnailCanvas[i]=elem;
        thumbnailContext[i]=elem.getContext("2d");

        var wrapper = document.createElement("div");
        wrapper.innerHTML = 
        `<div class="linkPageSelector">
          <canvas width="20" height="20" 
          class="pageSelector linkThumbnail${i+1}"></canvas>
          <div class="linkPageSelectorNumber">${i+1}</div>
        </div>
        `
        var popOverPageSelectorElem = wrapper.firstChild;
        linksPopOverElem.appendChild(popOverPageSelectorElem);
        linkThumbnailCanvas[i]=popOverPageSelectorElem.querySelector("canvas");
        linkThumbnailContext[i]=linkThumbnailCanvas[i].getContext("2d");
      }

      linkPageSelectorNumberElems = linksPopOverElem.querySelectorAll(".linkPageSelectorNumber");

      linksPopOverElem.addEventListener("click", function (e) {
        if (e.target.tagName.toLowerCase() === 'canvas') {
          var i = linkThumbnailCanvas.indexOf(e.target) + 1;
          createLink(linksPopOverColor, i);
          hideLinkPopover();
        }
      });
      //discard the unwanted popover
      document.body.addEventListener("click", function (e) {
        var targetTag = e.target.tagName.toLowerCase();
        if (targetTag === "body" || targetTag === 'center' 
          || targetTag === "table" || targetTag === "tbody"
          || targetTag === "tr" || targetTag === "td") {
          hideLinkPopover();
        }
      })

      for (var i=0;i<4;i++){
        elem = document.getElementById("col"+(i+1));
        linkDisplayElems[i] = elem;
        elem.innerHTML =
        `<div class="linkDisplay">
          <canvas width="20" height="20" 
          class="pageSelector"></canvas>
          <div class="linkPageSelectorNumber">--</div>
        </div>`;    
      }

      linkDisplayContainer = document.querySelector("#linkDisplayContainer")
      linkDisplayContainer.addEventListener("click", function (e) {
        if (timers[canvasIndex] <= 0) return;
        if (e.target.tagName.toLowerCase() === 'canvas') {
          var i = Array.from(linkDisplayContainer.querySelectorAll("canvas")).indexOf(e.target);
          showLinkPopover({x: e.pageX, y:e.pageY-40}, i, true);
        }
      });

      for (var i=0;i<4;i++){
        elem = document.getElementById("color_"+(i));        
        elem.style.backgroundColor=colorPalette[i];
        colorElem[i]=elem;
      }

      for (var i=0;i<numFrames;i++){
        elem = document.getElementById("layerItem"+(i+1));        
        layerElem[i]=elem;
      }


      bucketElem=document.getElementById("bucket");
      linkToolElem=document.getElementById("linkTool");


      for (var i=0;i<numFrames;i++){
        canvasses[i]=new Uint8Array(width*height);
      }

      for (var i=0;i<numFrames;i++){
        hyperlinks[i] = [0,0,0,0];
      }

      for (var i=0; i<numFrames; ++i){
        frameData[i]={strokesCount: 0, fillsCount: 0, hasBeenOpened: false, initialStrokeColor: -1};
      }

      visibleCanvas = document.getElementById("mainCanvas");
      visibleCanvas.addEventListener('mousedown', mouseDown,false);
      visibleCanvas.addEventListener('mouseup', mouseUp,false);
      visibleCanvas.addEventListener('mousemove', mouseMove,false);
      visibleCanvas.addEventListener('mouseout', mouseOut,false);

      var fileUploader = document.getElementById("my_file");
      fileUploader.addEventListener('change', readFile, false);

      window.addEventListener('mouseup', mouseUp,false);

      visibleContext = visibleCanvas.getContext("2d");
      visibleContext.imageSmoothingEnabled= false;
      id = visibleContext.createImageData(1,1); // only do this once per page
      id_d=id.data;
      setVisuals();
      setColor(colorIndex);
      document.getElementById("message").innerHTML = messages[0];

      getData();
      updateTimeDisplay();
      updateLinkPopover();

      if (location.search === "?leadership") {
        document.querySelector("body").className += " leadership";
      }
    }

 function leadership () {
  document.querySelector("body").className += " leadership";
 }

  function readFile(evt) {
    //Retrieve the first (and only!) File from the FileList object
    var f = evt.target.files[0]; 

    if (f) {
      var r = new FileReader();
      r.onload = function(e) { 
        var contents = e.target.result;
        var fromToken="<!--__EmbedBegin__-->";
        var endToken="<!--__EmbedEnd__-->";
        var fromIndex=contents.indexOf(fromToken);
        var endIndex=contents.indexOf(endToken);
        var ss1 = contents.substr(fromIndex+fromToken.length,endIndex-fromIndex-fromToken.length);
        var ss2=ss1.substr(ss1.indexOf("=")+2);
        var decoded = decodeURI(ss2);
        var decoded2 = decoded.substring(0, decoded.length - 3);
        if (decoded2.substring(decoded2.length - 1) == "\"") {
          decoded2 = decoded2.substring(0, decoded2.length - 1);
        }
        stringToState(decoded2);
        setVisuals(true);
        setLayer(canvasIndex+1); 
      }
      r.readAsText(f);
    } else { 
      alert("Failed to load file");
    }
  }



  function getParameterByName(name) {
      name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
      var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
          results = regex.exec(location.search);
      return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
  }


  function strip_http(url) {
     url = url.replace(/^https?:\/\//,'');
     return url;
  }

  function getData(){ 
    var id = getParameterByName("p").replace(/[\\\/]/,"");
    if (id===null||id.length===0) {
      
      return;
    }

    var githubURL = 'https://api.github.com/gists/'+id;

    var githubHTTPClient = new XMLHttpRequest();
    githubHTTPClient.open('GET', githubURL);
    githubHTTPClient.onreadystatechange = function() {
      if(githubHTTPClient.readyState!=4) {
        return;
      }   
      var result = JSON.parse(githubHTTPClient.responseText);
      if (githubHTTPClient.status===403) {
        alert(result.message);
      } else if (githubHTTPClient.status!==200&&githubHTTPClient.status!==201) {
        alert("HTTP Error "+ githubHTTPClient.status + ' - ' + githubHTTPClient.statusText);
      }
      var result = JSON.parse(githubHTTPClient.responseText);
      var code=result["files"]["game.txt"]["content"];
      
      stringToState(code);
      setVisuals(true);
      setLayer(canvasIndex+1); 
    }
    githubHTTPClient.setRequestHeader("Content-type","application/x-www-form-urlencoded");
    githubHTTPClient.send();
  }


    function drawThumbnail(n){
      var thumbWidth=thumbSize;
      var thumbHeight=thumbSize;
      thumbnailCanvas[n].width = thumbWidth;
      thumbnailCanvas[n].height = thumbWidth;
      var thumbWidthScale = width/thumbWidth;
      var thumbHeightScale = height/thumbHeight;
      thumbCtx=thumbnailContext[n];
      thumbCtx.fillStyle="#FF0000";
      thumbCtx.fillRect(0,0,thumbWidth,thumbWidth);
      //thumbCtx.imageSmoothingEnabled = false;
      //thumbCtx.mozImageSmoothingEnabled = false;
      //thumbCtx.oImageSmoothingEnabled = false;
      //thumbCtx.webkitImageSmoothingEnabled = false;
      //thumbCtx.msImageSmoothingEnabled = false;
      var canvas=canvasses[n];
      var colorUsageCount=[];
      for (var j=0;j<thumbHeight;j++){
        for (var i=0;i<thumbWidth;i++){
          for (var countIndex=0; countIndex<colorPalette.length; ++countIndex) {
            colorUsageCount[countIndex]=0;
          }
          for (var j2=0;j2<thumbHeightScale;j2++){
            for (var i2=0;i2<thumbWidthScale;i2++){
              var sample = canvas[i*thumbWidthScale+i2+width*(j*thumbHeightScale+j2)];
              ++colorUsageCount[sample];
            }
          }
          var majorityColorIndex=0;
          for (var countIndex=0; countIndex<colorPalette.length; ++countIndex) {
            if (colorUsageCount[countIndex] > colorUsageCount[majorityColorIndex]) {
              majorityColorIndex = countIndex;
            }
          }
          thumbCtx.fillStyle=colorPalette[majorityColorIndex];
          thumbCtx.fillRect(i,j,1,1);          
        }
      }

      //copy image to the link tool thumbnail too
      var linkThumbCtx =linkThumbnailContext[n];
      linkThumbCtx.drawImage(thumbnailCanvas[n], 0, 0);
    }

    function setVisuals(genAllThumbnails){
      //visibleContext.drawImage(canvasses[canvasIndex], 0, 0); 
      //visibleContext.drawImage(canvasses[canvasIndex], 0, 0,width*zoomFactor,height*zoomFactor); 
      canvas=canvasses[canvasIndex];
      // var colorUsageCount=[];
      // for (var countIndex=0; countIndex<colorPalette.length; ++countIndex) {
      //   colorUsageCount[countIndex]=0;
      // }
      for (var i=0;i<width;i++){
        for (var j=0;j<height;j++){
          var pixelIndex = canvas[i+width*j]; 
          visibleContext.fillStyle=colorPalette[pixelIndex];
          visibleContext.fillRect(i*zoomFactor,j*zoomFactor,zoomFactor,zoomFactor);
          // ++colorUsageCount[pixelIndex];
        }
      }
      // var majorityColorIndex=0;
      // for (var countIndex=0; countIndex<colorPalette.length; ++countIndex) {
      //   if (colorUsageCount[countIndex] > colorUsageCount[majorityColorIndex]) {
      //     majorityColorIndex = countIndex;
      //   }
      // }
      // document.body.style.backgroundColor = colorPalette[majorityColorIndex];
      if (genAllThumbnails===true){
        for (var i=0;i<numFrames;i++){
          drawThumbnail(i);
        }
      } else {
        drawThumbnail(canvasIndex);
      }
    }


  var drawing=0;


  function getCoords(e) {
    var x,y; 
    if(typeof e.offsetX !== "undefined") {
        x = e.offsetX;
        y = e.offsetY;
    }
    else {      
      var target = e.target || e.srcElement;
      var rect = target.getBoundingClientRect();
      x = e.clientX - rect.left,
      y = e.clientY - rect.top;
    } 
    return [x,y];
  }



  function uint8ar_copy(src)  {
      var dst = new Uint8Array(width*height);
      for (var i=0;i<src.length;i++){
        dst[i]=src[i];
      }
      return dst;
  }

  var undoList=new Array();
  function preserveUndoState() {
    console.log("preserving undo state");
    var undoItem = new Object();
    undoItem.canvasIndex=canvasIndex;
    undoItem.canvasDat=uint8ar_copy(canvasses[canvasIndex]);
    undoList.push(undoItem);
    if (undoList.length>30){
      undoList.shift();
    }

    if (shareLinkInner!==null){
      shareLinkInner.style.color="gray";
    }
  }

  function mouseDown(e){

    if (timers[canvasIndex] <= 0 || finished) return;
    e = e || window.event;
    var coords = getCoords(e);

    if (linkMode) {
      var coords = getCoords(e);
      var canvasX = Math.round(-1+coords[0]/zoomFactor);
      var canvasY = Math.round(-1+coords[1]/zoomFactor);
      var originColor = canvas[canvasX+width*canvasY];
      showLinkPopover({x: e.pageX, y:e.pageY}, originColor);
      return;
    }

    drawing=1;
    
    startTargetX=coords[0];
    startTargetY=coords[1];
    lastX=Math.round(-1+startTargetX/zoomFactor);
    lastY=Math.round(-1+startTargetY/zoomFactor);
    
    preserveUndoState();
    mouseMove(e);
    if(radius===0){
      drawing=0;
    }
  }

  function mouseUp(e){
    e = e || window.event;

    if (drawing){
      ++frameData[canvasIndex].strokesCount;
    }

    drawing=0;
    lastX=-1;
    lastY=-1;
  }

  function mouseOut(e){
    e = e || window.event;

    mouseMove(e);
    lastX=-1;
    lastY=-1;
  }


  function line (x1, y1,x2,y2) {
    var coordinatesArray = new Array();
    // Translate coordinates
    // Define differences and error check
    var dx = Math.abs(x2 - x1);
    var dy = Math.abs(y2 - y1);
    var sx = (x1 < x2) ? 1 : -1;
    var sy = (y1 < y2) ? 1 : -1;
    var err = dx - dy;
    // Set first coordinates
    coordinatesArray.push([x1,y1]);
    // Main loop
    while (!((x1 == x2) && (y1 == y2))) {
      var e2 = err << 1;
      if (e2 > -dy) {
        err -= dy;
        x1 += sx;
      }
      if (e2 < dx) {
        err += dx;
        y1 += sy;
      }
      // Set coordinates
      coordinatesArray.push([x1,y1]);
    }
    // Return the result
    return coordinatesArray;
  }

  function mouseMove(e){
    e = e || window.event;

    if (timers[canvasIndex] <= 0) {
      visibleCanvas.style.cursor="not-allowed";
      hideLinkPopover();
      return;
    }

    if (drawing===0)
      return;

    var coords = getCoords(e);

    var x = Math.round(-1+coords[0]/zoomFactor);
    var y = Math.round(-1+coords[1]/zoomFactor);


    var canvas=canvasses[canvasIndex];

    if (radius>0){
      if (frameData[canvasIndex].strokesCount==0) {
        frameData[canvasIndex].initialStrokeColor=colorIndex;
      }

      var points;
      if (lastX===-1) {
        points=[[x,y]];
      } else {
        points=line(x,y,lastX,lastY);
      }

      for (var i=0;i<points.length;i++){
        var p=points[i];

        drawCircle(canvas,p[0],p[1],radius,colorIndex);
      }
    } else {
      var p=[x,y];
      if (lastX===-1) {
        // nothin
      } else {
        p=[lastX,lastY];
      }

      floodFill(canvas, p[0], p[1], colorIndex);

      ++frameData[canvasIndex].fillsCount;
    }
  

    /*context.beginPath();
    context.arc(x, y, radius, 0, 2 * Math.PI, false);
    context.lineWidth = 0;
    context.fillStyle = 'green';
    context.fill();*/
    setVisuals();

    var coords = getCoords(e);
    lastX=Math.round(-1+coords[0]/zoomFactor);
    lastY=Math.round(-1+coords[1]/zoomFactor);
    
  }

  function clamp(value,min,max) {
    return Math.max(min, Math.min(max, value));
  }

  function drawCircleOfAnySize(canvas, x0, y0, radius, colorIndex){
    var x = radius;
    var y = 0;
    var decisionOver2 = 1 - x;   // Decision criterion divided by 2 evaluated at x=r, y=0
    var makePixelIndexer = function(){
      return function(i,j){
        var index = j*width + i;
        //index points to the R chanel of pixel 
        //at column i and row j calculated from top left
        return index;
      };
    }
    var pixelIndexer = makePixelIndexer(width);
    var drawPixel = function(x,y){
       var idx = pixelIndexer(x,y);
       canvas[idx] = colorIndex -1;
    };
    var drawRow = function(xL,xR,y){
      var idxL = Math.max(pixelIndexer(xL,y), y*width);
      var idxR = Math.min(pixelIndexer(xR,y), ((y+1)*width)-1);
      for (;idxL <= idxR; ++idxL) {
        canvas[idxL] = colorIndex;
      }
    };
    while(x >= y){
      drawRow(x0 - x, x0 + x, y0 + y); // a
      drawRow(x0 - y, x0 + y, y0 + x); // b
      drawRow(x0 - x, x0 + x, y0 - y); // c
      drawRow(x0 - y, x0 + y, y0 - x); // b
      // drawPixel( x + x0,  y + y0); // a
      // drawPixel( y + x0,  x + y0); // b
      // drawPixel(-x + x0,  y + y0); // a
      // drawPixel(-y + x0,  x + y0); // b
      // drawPixel(-x + x0, -y + y0); // c
      // drawPixel(-y + x0, -x + y0); // d
      // drawPixel( x + x0, -y + y0); // c
      // drawPixel( y + x0, -x + y0); // d
      y++;
      if (decisionOver2<=0){
        decisionOver2 += 2 * y + 1;   // Change in decision criterion for y -> y+1
      }else{
        x--;
        decisionOver2 += 2 * (y - x) + 1;   // Change for y -> y+1, x -> x-1
      }
    }
    // x = radius;
    // y = 0;
    // decisionOver2 = 1 - x
    // while(x >= y){
    //   drawPixel( x + x0,  y + y0); // a
    //   drawPixel( y + x0,  x + y0); // b
    //   drawPixel(-x + x0,  y + y0); // a
    //   drawPixel(-y + x0,  x + y0); // b
    //   drawPixel(-x + x0, -y + y0); // c
    //   drawPixel(-y + x0, -x + y0); // d
    //   drawPixel( x + x0, -y + y0); // c
    //   drawPixel( y + x0, -x + y0); // d
    //   y++;
    //   if (decisionOver2<=0){
    //     decisionOver2 += 2 * y + 1;   // Change in decision criterion for y -> y+1
    //   }else{
    //     x--;
    //     decisionOver2 += 2 * (y - x) + 1;   // Change for y -> y+1, x -> x-1
    //   }
    // }
  }

  function drawCircle(canvas,x,y,radius,colorIndex){
    radius=Math.floor(radius/2)+1;
    if (radius==1){
      var idx=Math.max(0, Math.min(width-1, x))+width*Math.min(height-1, y);
      canvas[idx]=colorIndex;
      return;
    } else if (radius==2){
      var points = [[x,y],[x-1,y],[x,y+1],[x+1,y],[x,y-1]];
      for (var i=0;i<points.length;i++){
        var px=points[i][0];
        var py=points[i][1];
        if (px>=0&&px<100&&py>=0&&py<100){
          canvas[px+width*py]=colorIndex;
        }
      }
      return;
    } else if (radius==3){
      var points = [
                  [x-1,y+2],[x,y+2],[x+1,y+2],
        [x-2,y+1],[x-1,y+1],[x,y+1],[x+1,y+1],[x+2,y+1],
        [x-2,y  ],[x-1,y  ],[x,y  ],[x+1,y  ],[x+2,y  ],
        [x-2,y-1],[x-1,y-1],[x,y-1],[x+1,y-1],[x+2,y-1],
                  [x-1,y-2],[x,y-2],[x+1,y-2]
        ];
      for (var i=0;i<points.length;i++){
        var px=points[i][0];
        var py=points[i][1];
        if (px>=0&&px<100&&py>=0&&py<100){
          canvas[px+width*py]=colorIndex;
        }
      }
      return;

    }

    drawCircleOfAnySize(canvas, x, y, radius, colorIndex);
    return;

    for (var i=Math.max(x-radius,0);i<=Math.min(x+radius,width-1);i++){
      for (var j=Math.max(y-radius,0);j<=Math.min(y+radius,height-1);j++){
        var dx = i-x;
        var dy = j-y;
        if ((dx*dx+dy*dy)<radius*radius){
          canvas[i+width*j]=colorIndex;          
        }
      }
    }  
  }

  function floodFill(canvas,x,y,colorIndex){
    var points = [[x,y]];
    originColor = canvas[x+width*y];
    if (originColor===colorIndex){
      return;
    }

    for (var i=0;i<points.length;i++){
      var p = points[i];
      var pIndex = p[0]+width*p[1];
      if (canvas[pIndex]===colorIndex) {
        continue;
      } else {
        canvas[pIndex]=colorIndex;
        borderPoints = [[p[0]+1,p[1]],[p[0]-1,p[1]],[p[0],p[1]+1],[p[0],p[1]-1]];
        for (var j=0;j<borderPoints.length;j++){
          var borderPoint=borderPoints[j]; 
          var bpx=borderPoint[0];
          var bpy=borderPoint[1];
          var bpi=bpx+width*bpy;
          if (
            bpx>=0 &&
            bpx<width &&
            bpy>=0 &&
            bpy<height &&
            canvas[bpi]===originColor){
            points.push([bpx,bpy]);
          }
        }
      }
    }
  }

</script>

    <style type="text/css">
/*<![CDATA[*/
#maincanvas {
  cursor:crosshair;
}

#timer {
  font-size: 22px;
  padding: 4px;
  color:white;
}

#message {
  font-size: 25px;
  color:white;
  margin: 5px;
  width:600px;
  height: 60px;
}

.button {
  font-size:20px;
  border: 1px solid white;
  padding: 5px;
  margin:10px;
  display: inline-block;
  text-decoration: none;   
}

.button:hover {
  background-color: grey;
}

.button.disabled:hover {
  background-color: inherit;
}

.button.disabled {
  color: grey;
  border-color: grey;
}

#instructions {
  position: absolute;
  width: 99%;
  display: block;
  background-color: black;
  z-index: 1;

}

.secret {
  display: none;
}

.leadership .secret {
  display: inherit;
}

.pageSelector {
  border:2px solid gray;
  background-color:black;  
}

.linksPopOver {
  position: absolute;
  display: block;
  border: 2px solid grey;
  top: 200px;
  width:300px;
  left: calc(50% - 150px);
  background-color: black;
  text-align: center;
  padding: 5px;
}
.colorDisplay {
  display: inline-block;
  border: 2px solid grey;
  width: 30px;
  height: 30px;
  vertical-align: middle;
  border-radius: 50%;
}
.linkPageSelector {
  display: inline-block;
  width: 60px;
  height: 70px;
}
.linkDisplay {
  text-align: center;
  width: 100%; /*it's in a table cell*/
}

.hidden {
  display: none;
}

body {
    -webkit-user-select: none; /* webkit (safari, chrome) browsers */
    -moz-user-select: none; /* mozilla browsers */
    -khtml-user-select: none; /* webkit (konqueror) browsers */
    -ms-user-select: none; /* IE10+ */ 
}
                 select {
                  background-color:black;
                  color:white;
                  text-indent:5px;
                 }
                canvas {
                  position:relative;
                }
                 ul {
                 list-style-type: none;
                 }
                 input {
                 background-color: black;
                 color:white;
                 font-size: 200%;
                 text-align: center;
                 margin-bottom: 5px;
                 }
                 li {
                 font-size: 150%;                 
                  width:100%;
                 }
                 a.layerItem{
                  background-color: clear;
                  width:100%;
                  display:block;
                 }
                 a.layerItem.selectedItem{
                  color: black;
                  background-color: white;
                 }
                 img.selected {
                  border: 2px solid red;
                 }
                 li.selected  {
                 cursor:auto;
                 color:white;
                 }
                 a{
                  white-space:nowrap;
                }
                 div.selected {
                 height:30px; 
                 width:30px;
                 border: 2px solid red;
                 }
                 div.unselected {
                 height:30px; 
                 width:30px;
                 border: 2px solid black;
                 }
                 img.radius {
                  border: 1px solid transparent;
                 }
                 img.selected, a.selected {
                  border: 1px solid red; 
                 }
                 .textButton {
                   display: block;
                   text-align:center;
                   border: 1px solid white;
                   font-size: 32px;
                 }
                 select {
                 width:100%;
                 -webkit-appearance: none;
                 -moz-appearance: none;
                 }
                 select::-ms-expand {
                 display: none;
                 }
                 canvas#dropdownthumb {
                  border:2px solid gray; 
                  background-color:black;
                 }
    /*]]>*/
    </style>
    <title>
      faithgame
    </title>
  </head>
  <body onload="init();" ondragstart="return false;" ondrop="return false;">
  <center>
    <div id="instructions">
      <h1>faithgame</h1>
      <p>faithgame is a denomination of <a href="http://www.flickgame.org/">flickgame</a></p>
      <p>by first <a href="http://www.flickgame.org/help.html">knowing flickgame</a>, you may come to better understand our ways</p>
      <p>faithgames should not be created without first acknowledging the faithgame canon</p>
      <p><a href="/gallery.html" class="button">contemplate existing faithgames</a></p>
      <br>
      <h1>performing the faithgame ritual</h1>
      <p>do not attempt the faithgame ritual unprepared</p>
      <p>the faithgame ritual shall take place in 20 minutes of isolation and silence</p>      
      <p>the faithgame ritual shall always result in a completed faithgame</p>
      <p>faithgames shall consist of 10 frames, drawn with 4 colours</p>
      <p>each frame shall be drawn in 2 minutes and in accordance with its unique rules</p>
      <p>each colour may act as a link to one of the other frames</p>
      <p>links shall be set using the drop-down menus below the colour selection palette</p>
      <p>frames shall be switched between via the menu to the left of the canvas</p>
      <p>faithgames shall only be released anonymously</p>
      <p>100 steps must be taken before repeating the faithgame ritual</p>
      <p><a onclick="begin();return false;" href="#" class="button">begin the faithgame ritual</a></p>
      <br>
    </div>
    <table cellpadding="10">
      <tr>
        <td valign="top">
          <br />
          <br />
          <br />
          <br />
          <ul>
            <li> 
              <a class="layerItem selectedItem" id="layerItem1" href="#" onclick="setLayer(1);return false;">
              <div class="timer" id="thumbTimer1"></div>
              <canvas id="thumbnail1" width="10" height="10" class="pageSelector"></canvas>
              1</a>
            </li>
            <li> 
              <a class="layerItem" id="layerItem2" href="#" onclick="setLayer(2);return false;">
              <div class="timer" id="thumbTimer2"></div>
              <canvas id="thumbnail2" width="10" height="10" class="pageSelector"></canvas>
              2</a>
            </li>
            <li> 
              <a class="layerItem" id="layerItem3" href="#" onclick="setLayer(3);return false;">
              <div class="timer" id="thumbTimer3"></div>
              <canvas id="thumbnail3" width="10" height="10" class="pageSelector"></canvas>
              3</a>
            </li>
            <li> 
              <a class="layerItem" id="layerItem4" href="#" onclick="setLayer(4);return false;">
              <div class="timer" id="thumbTimer4"></div>
              <canvas id="thumbnail4" width="10" height="10" class="pageSelector"></canvas>
              4</a>
            </li>
            <li> 
              <a class="layerItem" id="layerItem5" href="#" onclick="setLayer(5);return false;">
              <div class="timer" id="thumbTimer5"></div>
              <canvas id="thumbnail5" width="10" height="10" class="pageSelector"></canvas>
              5</a>
            </li>
            <li> 
              <a class="layerItem" id="layerItem6" href="#" onclick="setLayer(6);return false;">
              <div class="timer" id="thumbTimer6"></div>
              <canvas id="thumbnail6" width="10" height="10" class="pageSelector"></canvas>
              6</a>
            </li>
            <li> 
              <a class="layerItem" id="layerItem7" href="#" onclick="setLayer(7);return false;">
              <div class="timer" id="thumbTimer7"></div>
              <canvas id="thumbnail7" width="10" height="10" class="pageSelector"></canvas>
              7</a>
            </li>
            <li> 
              <a class="layerItem" id="layerItem8" href="#" onclick="setLayer(8);return false;">
              <div class="timer" id="thumbTimer8"></div>
              <canvas id="thumbnail8" width="10" height="10" class="pageSelector"></canvas>
              8</a>
            </li>
            <li> 
              <a class="layerItem" id="layerItem9" href="#" onclick="setLayer(9);return false;">
              <div class="timer" id="thumbTimer9"></div>
              <canvas id="thumbnail9" width="10" height="10" class="pageSelector"></canvas>
              9</a>
            </li>
            <li> 
              <a class="layerItem" id="layerItem10" href="#" onclick="setLayer(10);return false;">
              <div class="timer" id="thumbTimer10"></div>
              <canvas id="thumbnail10" width="10" height="10" class="pageSelector"></canvas>
              10</a>
            </li>
          </ul>
        </td>
        <td valign="top">
          <table>
            <tr>
              <td>
                <table>
                  <tr>
                    <td>
                      <center>
                        <div id="message"></div>
                        <canvas id="mainCanvas" width="600" height="600" style="border:2px solid gray; background-color:black;"></canvas>
                        <br />
                        <table style="border:2px solid gray; margin-top:2px" margin="0">
                          <tr height="16">
                            <td style="text-align:right">
                            color
                            </td>
                            <td>
                             <a href="#" onclick="setColor(0);return false;">
                              <div  class=
                              "unselected" id="color_0"></div></a>
                            </td>
                            <td>
                             <a href="#" onclick="setColor(1);return false;">
                              <div class=
                              "unselected" id="color_1"></div></a>
                            </td>
                            <td>
                             <a href="#" onclick="setColor(2);return false;">
                              <div  class=
                              "selected" id="color_2"></div></a>
                            </td>
                            <td>
                             <a href="#" onclick="setColor(3);return false;">
                              <div class=
                              "unselected" id="color_3"></div></a>
                            </td>
                          </tr>
                          <tr id="linkDisplayContainer">
                            <td>
                            links to
                            </td>
                            <td>
                              <div id="col1"></div>
                            </td>
                            <td>
                              <div id="col2"></div>
                            </td>
                            <td>
                              <div id="col3"></div>
                            </td>
                            <td>
                              <div id="col4"></div>
                            </td>                           
                          </tr>
                        </table>
                      <div style="display:none" class="importantTip" id="linkTip">the colors on each page can be made to link to another page using the boxes above</div>
                      <a href="#" onclick="shareClick();return false;" style="display:none" class="button" id="shareButton">&ocir; it is done</a>
                      <br />
                      <div id="shareLink"></div>
                      
                      <div class="secret">
                        <a href="#" onclick="document.getElementById('my_file').click();return false;">&sdotb; import</a><br />
                        <input type="file" accept=".html" id="my_file" style="display: none;" />
                        <a href="#" onclick="exportClick();return false;">&sdotb; export</a><br />
                        <input type="file" accept=".html" id="my_file" style="display: none;" />
                      </div>
                      </center>
                    </td>
                    <td valign="top" id="brushes">
                      <br />
                      <br />
                      <br />
                      <br />
                      <br />
                      <a href="#" onclick="setRadius(16);return false;"><img src="16.png" class="radius" id="radius_16" /></a>
                      <br />
                      <a href="#" onclick="setRadius(13);return false;"><img src="13.png" class="radius" id="radius_13" /></a>
                      <br />
                      <a href="#" onclick="setRadius(11);return false;"><img src="11.png" class="radius" id="radius_11" /></a>
                      <br />
                      <a href="#" onclick="setRadius(9);return false;"><img src="9.png" class="radius" id="radius_9" /></a>
                      <br />
                      <a href="#" onclick="setRadius(7);return false;"><img src="7.png" class="radius" id="radius_7" /></a>
                      <br />
                      <a href="#" onclick="setRadius(5);return false;"><img src="5.png" class="radius selected" id="radius_5" /></a>
                      <br />
                      <a href="#" onclick="setRadius(3);return false;"><img src="3.png" class="radius" id="radius_3" /></a>
                      <br />
                      <a href="#" onclick="setRadius(1);return false;"><img src="1.png" class="radius" id="radius_1" /></a>
                      <br />
                      <a href="#" onclick="setRadius(0);return false;"><img src="bucket.png" class="radius" id="bucket"/></a>
                      <br />
                      <a class="radius textButton" id="linkTool" href="#" onclick="setLinkTool();return false;">↦</a>
                      <br />
                      <!--we must not abandon our efforts
                      <a href="#" onclick="clearPalette();return false;"><img src="clear.png" class="radius" id="bucket"/></a>-->
                    </td>
                  </tr>
                </table>
                <br />
              </td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    </center>
  <div class="linksPopOver hidden">
    <p><div class="colorDisplay"></div> players who click on this color will move to another page:</p>
    <!-- the 10 canvas links will appear-->
  </div>
  </body>
</html>
